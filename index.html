<!-- Based on example from http://stackoverflow.com/questions/12479895/obtaining-bigquery-data-from-javascript-code -->

<html>

<head>
    <script src="//code.jquery.com/jquery-2.1.0.min.js"></script>
    <script src="//code.highcharts.com/stock/highstock.js"></script>
    <script src="//code.highcharts.com/stock/modules/exporting.js"></script>

    <script type="text/javascript">
    $(function() {

        Highcharts.setOptions({
            global: {
                useUTC: false
            }
        });

        // This will hold our data
        var seriesByName = {};
        var lastValueByFallback = {};

        // Create the chart
        $('#container').highcharts('StockChart', {
            chart: {
                events: {
                    load: function() {
                        var chart = this;

                        // Once the chart is loaded, set up a websocket to update the data
                        var ws = new WebSocket("wss://pure-journey-3547.herokuapp.com/stream/fallback");
                        ws.onopen = function() {
                            console.log("WebSocket opened")
                        };
                        ws.onmessage = function(evt) {
                            var msg = evt.data;
                            var resp = JSON.parse(msg);
                            if (resp.succeeded) {
                                var asOf = resp.asOfSeconds * 1000;
                                Object.keys(resp.dims.fallback).forEach(function(name) {
                                    if (name == "total") {
                                        // ignore total
                                        return;
                                    }
                                    var fallback = resp.dims.fallback[name];
                                    var bytesGiven = (fallback.counters.bytesGiven || 0);
                                    var s = seriesByName[name];
                                    if (!s) {
                                        var data = [];
                                        var intervalInSeconds = 30;
                                        // Add some 0 data leading up to the current value to size the navigator
                                        for (var i=-1 * 24 * 60 * 60 / intervalInSeconds; i<=0; i++) {
                                            var date = asOf + i * intervalInSeconds * 1000;
                                            data.push([date, 0]);
                                        }
                                        lastValueByFallback[name] = bytesGiven;
                                        s = chart.addSeries({
                                            name: name.substring(9),
                                            data: data
                                        })
                                        seriesByName[name] = s;
                                    } else {
                                        var delta = bytesGiven - (lastValueByFallback[name] || 0);
                                        s.addPoint([asOf, Math.ceil(delta / 1024 / 1024)], true, true);
                                        lastValueByFallback[name] = bytesGiven;
                                    }
                                });
                            } else {
                                console.log("Response was unsuccessful", resp["error"]);
                            }
                        };
                        ws.onclose = function() {
                            // websocket is closed.
                            console.log("WebSocket closed");
                        };
                    }
                }
            },

            rangeSelector: {
                buttons: [{
                    count: 1,
                    type: 'minute',
                    text: '1M'
                }, {
                    count: 10,
                    type: 'minute',
                    text: '10M'
                }, {
                    count: 1,
                    type: 'hour',
                    text: '1H'
                }, {
                    count: 24,
                    type: 'hour',
                    text: '24H'
                }, {
                    type: 'all',
                    text: 'All'
                }],
                inputEnabled: false,
                selected: 0
            },

            title: {
                text: 'Change in Megabytes Given by Fallback'
            },

            exporting: {
                enabled: false
            },

            // yAxis: {
            //     type: 'logarithmic'
            // },

            series: []
        });
    });
    </script>
</head>

<body>
    <div id="container" style="height: 400px; min-width: 310px"></div>
</body>

</html>
