<!DOCTYPE html>
<html>
<!-- Based on example from http://stackoverflow.com/questions/12479895/obtaining-bigquery-data-from-javascript-code -->

<head>
    <script src="//code.jquery.com/jquery-2.1.0.min.js"></script>
    <script src="//code.highcharts.com/stock/highstock.js"></script>
    <script src="//code.highcharts.com/stock/modules/exporting.js"></script>

    <script type="text/javascript">
    $(function() {
        var INTERVAL_IN_SECONDS = 30;
        var SHOWN_COUNTRIES = {
            cn: true,
            ir: true,
            us: true,
            total: true
        };

        Highcharts.setOptions({
            global: {
                useUTC: false
            }
        });

        var ws = new WebSocket("wss://pure-journey-3547.herokuapp.com/stream/");
        ws.onopen = function() {
            console.log("WebSocket opened")
        };
        ws.onmessage = function(evt) {
            var msg = evt.data;
            var resp = JSON.parse(msg);
            if (resp.succeeded) {
                var asOf = resp.asOfSeconds * 1000;
                charts.forEach(function(update) {
                    update(asOf, resp.dims);
                });
            } else {
                console.log("Response was unsuccessful", resp["error"]);
            }
        };
        ws.onclose = function() {
            // websocket is closed.
            console.log("WebSocket closed");
        };

        // Put your charts here
        var charts = [
            make('kbpsFallbacks', 'KBps Fallbacks', function(context, asOf, dims) {
                Object.keys(dims.fallback).forEach(function(name) {
                    if (name == "total") {
                        // ignore total
                        return;
                    }
                    var fallback = dims.fallback[name];
                    // Remove leading "instance_"
                    name = name.substring(9)
                    var bytesGiven = (fallback.counters.bytesGiven || 0);
                    var s = context.getSeries(asOf, name);
                    var priorValue = context.priorValues[name];
                    if (typeof(priorValue) !== "undefined") {
                        var delta = bytesGiven - (priorValue.value || 0);
                        s.addPoint([asOf, Math.ceil(delta / 1024.0 / (asOf - priorValue.asOf) * 1000)], false, false);
                    }
                    context.priorValues[name] = {asOf: asOf, value: bytesGiven};
                });
            }, {
                yAxis: {
                    type: 'logarithmic',
                }
            }),

            make('kbpsPeers', 'KBps Peers', function(context, asOf, dims) {
                Object.keys(dims.country).forEach(function(name) {
                    if (!(name in SHOWN_COUNTRIES)) {
                        // ignore everything except total
                        return;
                    }
                    var country = dims.country[name];
                    var bytesGiven = (country.counters.bytesGivenByPeer || 0);
                    var s = context.getSeries(asOf, name);
                    var priorValue = context.priorValues[name];
                    if (typeof(priorValue) !== "undefined") {
                        var delta = bytesGiven - (priorValue || 0);
                        s.addPoint([asOf, Math.ceil(delta / 1024.0 / (asOf - priorValue.asOf) * 1000)], false, false);
                    }
                    context.priorValues[name] = {asOf: asOf, value: bytesGiven};
                });
            }),

            make('usersOnline', 'Users Online by Country', function(context, asOf, dims) {
                Object.keys(dims.country).forEach(function(name) {
                    if (!(name in SHOWN_COUNTRIES)) {
                        return;
                    }
                    var country = dims.country[name];
                    var online = (country.gauges.userOnline || 0);
                    var s = context.getSeries(asOf, name);
                    s.addPoint([asOf, online], false, false);
                });
            }),



        ];

        // Constructs a new chart

        function make(id, title, onData, options) {
            var fullOptions = $.extend({
                rangeSelector: {
                    buttons: [{
                        count: 1,
                        type: 'minute',
                        text: '1M'
                    }, {
                        count: 10,
                        type: 'minute',
                        text: '10M'
                    }, {
                        count: 1,
                        type: 'hour',
                        text: '1H'
                    }, {
                        count: 24,
                        type: 'hour',
                        text: '24H'
                    }, {
                        type: 'all',
                        text: 'All'
                    }],
                    inputEnabled: false,
                    selected: 1
                },

                title: {
                    text: title
                },

                exporting: {
                    enabled: false
                },

                series: []
            }, options)

            $('#' + id).highcharts('StockChart', fullOptions);

            var chart = $('#' + id).highcharts();
            var seriesByName = {};

            var context = {
                priorValues: {},
                getSeries: function(asOf, name) {
                    var s = seriesByName[name];
                    if (!s) {
                        s = chart.addSeries({
                            name: name,
                            data: []
                        })
                        seriesByName[name] = s;
                    }
                    return s;
                }
            }

            return function(asOf, dims) {
                onData(context, asOf, dims);
                chart.redraw();
            }
        }
    });
    </script>

    <style type="text/css">
    .chart {
        width: 500px;
        height: 300px;
        float: left;
        border: 1px solid;
        margin-left: 10px;
        margin-top: 10px;
    }
    </style>
</head>

<body>
    <div id="kbpsFallbacks" class="chart"></div>
    <div id="kbpsPeers" class="chart"></div>
    <div id="usersOnline" class="chart"></div>
</body>

</html>
